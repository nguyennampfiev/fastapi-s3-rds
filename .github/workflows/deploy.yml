name: CI/CD FastAPI (uv) Deployment

on:
  push:
    branches:
      - main

jobs:
  # --------------------------
  # 1ï¸âƒ£ Run Tests
  # --------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install uv
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Step 3: Sync dependencies with uv
      - name: Sync dependencies
        run: uv sync --frozen

      # Step 4: Run Pytest
      - name: Run Pytest
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/mydb
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION: eu-north-1
        run: uv run pytest -v --disable-warnings

  # --------------------------
  # 2ï¸âƒ£ Deploy to EC2
  # --------------------------
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup SSH key
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # Step 3: Deploy code
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@13.61.178.204 '
            set -e
            cd ~/fastapi-s3-rds || exit 1

            echo "ğŸš€ Pulling latest changes..."
            git fetch origin main
            git reset --hard origin/main

            # Install uv if not installed
            if ! command -v uv > /dev/null; then
              curl -LsSf https://astral.sh/uv/install.sh | bash
            fi
            export PATH="$HOME/.local/bin:$PATH"

            echo "ğŸ”„ Syncing dependencies..."
            uv sync --frozen

            echo "ğŸ” Restarting FastAPI service..."
            sudo systemctl restart fastapi

            echo "âœ… Deployment successful!"
          '
